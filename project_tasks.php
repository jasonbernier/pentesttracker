<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);
require 'db.php';
session_start();

// Check if the user is logged in
if (!isset($_SESSION['loggedin'])) {
    header('Location: index.php');
    exit;
}

// Only allow admins to manage tasks
if ($_SESSION['role'] !== 'admin') {
    echo "Access Denied. You must be an admin to manage tasks.";
    exit;
}

// Handle task management POST requests
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['add_task'])) {
        $task_name = $_POST['task_name'] ?? '';
        $description = $_POST['description'] ?? '';
        $status = $_POST['status'] ?? 'Pending';
        $deadline = $_POST['deadline'] ?? date('Y-m-d');
        $comments = $_POST['comments'] ?? '';
        $assigned_user = $_POST['assigned_user'] ?? '';
        $project_id = $_POST['project_id'] ?? '';

        if (!empty($task_name) && !empty($description) && !empty($assigned_user) && !empty($project_id)) {
            $insert_stmt = $pdo->prepare("INSERT INTO Tasks (task_name, description, status, deadline, comments, assigned_user, project_id) VALUES (?, ?, ?, ?, ?, ?, ?)");
            if ($insert_stmt->execute([$task_name, $description, $status, $deadline, $comments, $assigned_user, $project_id])) {
                echo "<p>Task added successfully.</p>";
            } else {
                echo "<p>Error adding task: " . $insert_stmt->errorInfo()[2] . "</p>";
            }
        } else {
            echo "<p>Please fill in all fields.</p>";
        }
    } elseif (isset($_POST['delete_task_id'])) {
        $delete_task_id = $_POST['delete_task_id'];

        // First, delete any comments associated with the task
        $delete_comments_stmt = $pdo->prepare("DELETE FROM Comments WHERE task_id = ?");
        $delete_comments_stmt->execute([$delete_task_id]);

        // Now delete the task
        $delete_stmt = $pdo->prepare("DELETE FROM Tasks WHERE task_id = ?");
        if ($delete_stmt->execute([$delete_task_id])) {
            echo "<p>Task deleted successfully.</p>";
        } else {
            echo "<p>Error deleting task: " . $delete_stmt->errorInfo()[2] . "</p>";
        }
    } elseif (isset($_POST['update_status'])) {
        $task_id = $_POST['task_id'];
        $new_status = $_POST['new_status'];
        $update_stmt = $pdo->prepare("UPDATE Tasks SET status = ? WHERE task_id = ?");
        if ($update_stmt->execute([$new_status, $task_id])) {
            echo "<p>Task status updated successfully.</p>";
        } else {
            echo "<p>Error updating task status: " . $update_stmt->errorInfo()[2] . "</p>";
        }
    } elseif (isset($_POST['update_project'])) {
        $task_id = $_POST['task_id'];
        $new_project = $_POST['new_project'];
        $update_stmt = $pdo->prepare("UPDATE Tasks SET project_id = ? WHERE task_id = ?");
        if ($update_stmt->execute([$new_project, $task_id])) {
            echo "<p>Task project updated successfully.</p>";
        } else {
            echo "<p>Error updating task project: " . $update_stmt->errorInfo()[2] . "</p>";
        }
    }
}

// Fetch all tasks along with the user who added them and the project name
$tasks = $pdo->query("SELECT Tasks.task_id, Tasks.task_name, Tasks.description, Tasks.status, Users.username AS assigned_username, Projects.project_name 
                      FROM Tasks 
                      LEFT JOIN Users ON Tasks.assigned_user = Users.user_id 
                      LEFT JOIN Projects ON Tasks.project_id = Projects.project_id")->fetchAll();

// Fetch all users to populate the assigned user dropdown
$users = $pdo->query("SELECT user_id, username FROM Users")->fetchAll();

// Fetch all projects
$projects = $pdo->query("SELECT project_id, project_name FROM Projects")->fetchAll();

?>
<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Manage Tasks</title>
    <link rel='icon' href='jojo_gangsta.ico' type='image/x-icon'>
    <link rel='stylesheet' href='styles.css'>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 10px;
        }
        .content {
            background: white;
            padding: 20px;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 90%;
        }
        input[type='text'], textarea {
            padding: 8px;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class='content'>
        <h1>Manage Tasks</h1>
        <button onclick="location.href='dashboard.php'">Dashboard</button>
        <button onclick="location.href='logout.php'">Log Out</button>
        <h2>Add New Task</h2>
        <form method='post'>
            Task Name: <input type='text' name='task_name' required><br>
            Description: <input type='text' name='description' required><br>
            Status: <select name='status'>
                        <option value='Pending'>Pending</option>
                        <option value='In Progress'>In Progress</option>
                        <option value='Completed'>Completed</option>
                    </select><br>
            Deadline: <input type='date' name='deadline' required><br>
            Comments: <textarea name='comments'></textarea><br>
            Assigned User: <select name='assigned_user' required>
                <?php foreach ($users as $user): ?>
                    <option value="<?= htmlspecialchars($user['user_id']) ?>"><?= htmlspecialchars($user['username']) ?></option>
                <?php endforeach; ?>
            </select><br>
            Project: <select name='project_id' required>
                <?php foreach ($projects as $project): ?>
                    <option value="<?= htmlspecialchars($project['project_id']) ?>"><?= htmlspecialchars($project['project_name']) ?></option>
                <?php endforeach; ?>
            </select><br>
            <input type='submit' value='Add Task'>
        </form>
        <h2>Task List</h2>
        <table>
            <tr>
                <th>ID</th>
                <th>Task Name</th>
                <th>Description</th>
                <th>Status</th>
                <th>Assigned User</th>
                <th>Project</th>
                <th>Update Status</th>
                <th>Update Project</th>
                <th>Delete Task</th>
            </tr>
            <?php foreach ($tasks as $task): ?>
                <tr>
                    <td><?= htmlspecialchars($task['task_id']) ?></td>
                    <td><?= htmlspecialchars($task['task_name']) ?></td>
                    <td><?= htmlspecialchars($task['description']) ?></td>
                    <td><?= htmlspecialchars($task['status']) ?></td>
                    <td><?= htmlspecialchars($task['assigned_username']) ?></td>
                    <td><?= htmlspecialchars($task['project_name']) ?></td>
                    <td>
                        <form method='post'>
                            <input type='hidden' name='task_id' value='<?= htmlspecialchars($task['task_id']) ?>'>
                            <select name='new_status'>
                                <option value='Pending'>Pending</option>
                                <option value='In Progress'>In Progress</option>
                                <option value='Completed'>Completed</option>
                            </select>
                            <input type='submit' name='update_status' value='Update'>
                        </form>
                    </td>
                    <td>
                        <form method='post'>
                            <input type='hidden' name='task_id' value='<?= htmlspecialchars($task['task_id']) ?>'>
                            <select name='new_project'>
                                <?php foreach ($projects as $project): ?>
                                    <option value='<?= htmlspecialchars($project['project_id']) ?>'><?= htmlspecialchars($project['project_name']) ?></option>
                                <?php endforeach; ?>
                            </select>
                            <input type='submit' name='update_project' value='Update'>
                        </form>
                    </td>
                    <td>
                        <form method='post'>
                            <input type='hidden' name='delete_task_id' value='<?= htmlspecialchars($task['task_id']) ?>'>
                            <input type='submit' value='Delete'>
                        </form>
                    </td>
                </tr>
            <?php endforeach; ?>
        </table>
    </div>
</body>
</html>
