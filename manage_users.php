<?php
require 'db.php';
session_start();

if (!isset($_SESSION['loggedin'])) {
    header('Location: index.php');
    exit;
}

// Process user addition and promotion
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['new_username'], $_POST['new_password'], $_POST['confirm_password'])) {
        if ($_POST['new_password'] === $_POST['confirm_password']) {
            $username = $_POST['new_username'];
            $password = password_hash($_POST['new_password'], PASSWORD_DEFAULT);
            $role = $_POST['role'];

            $insert_stmt = $pdo->prepare("INSERT INTO Users (username, password, role) VALUES (?, ?, ?)");
            if ($insert_stmt->execute([$username, $password, $role])) {
                echo "<p>New user added successfully.</p>";
            } else {
                echo "<p>Error adding user: " . $insert_stmt->errorInfo()[2] . "</p>";
            }
        } else {
            echo "<p>Passwords do not match.</p>";
        }
    }

    if (isset($_POST['delete_user_id'])) {
        $user_id = $_POST['delete_user_id'];
        $delete_stmt = $pdo->prepare("DELETE FROM Users WHERE user_id = ?");
        if ($delete_stmt->execute([$user_id])) {
            echo "<p>User deleted successfully.</p>";
        } else {
            echo "<p>Error deleting user: " . $delete_stmt->errorInfo()[2] . "</p>";
        }
    }

    if (isset($_POST['promote_user_id'])) {
        $user_id = $_POST['promote_user_id'];
        $promote_stmt = $pdo->prepare("UPDATE Users SET role = 'admin' WHERE user_id = ?");
        if ($promote_stmt->execute([$user_id])) {
            echo "<p>User promoted to admin successfully.</p>";
        } else {
            echo "<p>Error promoting user: " . $promote_stmt->errorInfo()[2] . "</p>";
        }
    }
}

// Fetch all users
$users = $pdo->query("SELECT user_id, username, role FROM Users")->fetchAll();

// HTML Header and CSS
echo "<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Manage Users</title>
    <link rel='icon' href='jojo_gangsta.ico' type='image/x-icon'>
    <link rel='stylesheet' href='styles.css'>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 10px;
        }
        .content {
            background: white;
            padding: 20px;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 90%;  /* Increased width */
        }
        table, th, td {
            border: 1px solid #ddd;
            border-collapse: collapse;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        a, button {
            color: #06c;
            text-decoration: none;
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover, a:hover {
            text-decoration: underline;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class='content'>
        <h1>Manage Users</h1>
        <a href='dashboard.php'>Dashboard</a>
        <button onclick=\"location.href='logout.php'\">Log Out</button>
        <h2>Add New User</h2>
        <form method='post'>
            Username: <input type='text' name='new_username' required><br>
            Password: <input type='password' name='new_password' required><br>
            Confirm Password: <input type='password' name='confirm_password' required><br>
            Role: <select name='role'>
                <option value='user'>User</option>
                <option value='admin'>Admin</option>
            </select>
            <input type='submit' value='Add User'>
        </form>
        <h2>User List</h2>
        <table>
            <tr><th>ID</th><th>Username</th><th>Role</th><th>Action</th></tr>";
foreach ($users as $user) {
    echo "<tr>
          <td>" . htmlspecialchars($user['user_id']) . "</td>
          <td>" . htmlspecialchars($user['username']) . "</td>
          <td>" . htmlspecialchars($user['role']) . "</td>
          <td>
              <form method='post'>
                  <input type='hidden' name='delete_user_id' value='" . $user['user_id'] . "'>
                  <input type='submit' value='Delete' style='background-color: #007bff; color: white;'>
              </form>
              <form method='post'>
                  <input type='hidden' name='promote_user_id' value='" . $user['user_id'] . "'>
                  <input type='submit' value='Promote to Admin' style='background-color: #007bff; color: white;'>
              </form>
          </td>
          </tr>";
}
echo "</table>
    </div>
</body>
</html>";
?>