<?php
ini_set('display_errors', 1);
error_reporting(E_ALL);

require 'db.php';
session_start();

if (!isset($_SESSION['loggedin'])) {
    header('Location: index.php');
    exit;
}

$message = '';
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $task_name = $_POST['task_name'] ?? '';
    $description = $_POST['description'] ?? '';
    $status = $_POST['status'] ?? '';
    $deadline = $_POST['deadline'] ?? '';
    $comments = $_POST['comments'] ?? '';
    $project_id = $_POST['project_id'] ?? '';

    if (!empty($task_name) && !empty($description) && !empty($status) && !empty($deadline) && !empty($project_id)) {
        if (!isset($_SESSION['user_id'])) {
            $message = "Session error: User ID is not set.";
        } else {
            $insert_stmt = $pdo->prepare("INSERT INTO Tasks (task_name, description, status, user_id, deadline, comments, project_id) VALUES (?, ?, ?, ?, ?, ?, ?)");
            if ($insert_stmt->execute([$task_name, $description, $status, $_SESSION['user_id'], $deadline, $comments, $project_id])) {
                $message = "Task successfully added.";
            } else {
                $message = "Failed to add task. Error: " . $insert_stmt->errorInfo()[2];
            }
        }
    } else {
        $message = "Please fill in all fields.";
    }
}

function getProjects() {
    global $pdo;
    try {
        $stmt = $pdo->query("SELECT * FROM Projects");
        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    } catch (PDOException $e) {
        // If there is an SQL error, it will be displayed on the dashboard
        echo 'Project Error: ' . $e->getMessage();
        return [];
    }
}

echo "<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Create Task</title>
    <link rel='stylesheet' href='styles.css'>
    <link rel='icon' href='jojo_gangsta.ico' type='image/x-icon'>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 10px;
        }
        .content {
            background: white;
            padding: 20px;
            margin: 20px auto;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 90%;
        }
        input[type='text'], textarea, input[type='date'], select {
            padding: 8px;
            margin: 10px 0;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            padding: 8px 16px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class='content'>
        <h1>Create Task</h1>
        <br>
        <button onclick=\"location.href='dashboard.php'\">Dashboard</button>
        <button onclick=\"location.href='logout.php'\">Log Out</button>
        <br><br>
        <form action='create_task.php' method='post'>
            Task Name: <input type='text' name='task_name' required><br>
            Description: <textarea name='description' required></textarea><br>
            Status: <select name='status'>
                <option value='pending'>Pending</option>
                <option value='in_progress'>In Progress</option>
                <option value='completed'>Completed</option>
            </select><br>
            Deadline: <input type='date' name='deadline' required><br>
            Comments: <textarea name='comments'></textarea><br>
            Project: <select name='project_id'>";
            
$projects = getProjects();
foreach ($projects as $project) {
    echo "<option value='" . htmlspecialchars($project['project_id']) . "'>" . htmlspecialchars($project['project_name']) . "</option>";
}

echo "</select><br>";
echo "<button type='submit'>Add Task</button></form>";
echo (!empty($message) ? "<p>$message</p><br>" : "") . "
    </div>
</body>
</html>";
?>